x-keeper-common: &keeper-common
  build:
    context: .
    dockerfile: docker/keepers/Dockerfile
  restart: unless-stopped
  logging:
    driver: json-file
    options:
      max-size: "10m"
      max-file: "3"
  deploy:
    resources:
      limits:
        memory: 512M
        cpus: "0.5"

services:
  compound-keeper:
    <<: *keeper-common
    container_name: keeper-compound
    command: ["npx", "tsx", "scripts/keepers/compound-keeper.ts"]
    environment:
      CLUSTER: "${CLUSTER:-mainnet-beta}"
      I_UNDERSTAND_MAINNET: "${I_UNDERSTAND_MAINNET:-1}"
      RPC_URL: "${RPC_URL}"
      KEYPAIR: "/secrets/keeper.json"
      CCM_V3_MINT: "${CCM_V3_MINT}"
      HEALTHCHECK_FILE: "/tmp/keeper-heartbeat"
      HEALTHCHECK_MAX_AGE: "600"
      # DRY_RUN: "1"
      # COMPOUND_INTERVAL_MS: "300000"
    volumes:
      - ${KEEPER_KEYPAIR_PATH:-./.keys/keeper.json}:/secrets/keeper.json:ro
    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck.sh"]
      interval: 60s
      timeout: 5s
      retries: 3
      start_period: 30s

  harvest-fees-keeper:
    <<: *keeper-common
    container_name: keeper-harvest-fees
    command: ["npx", "tsx", "scripts/keepers/harvest-fees-keeper.ts"]
    environment:
      CLUSTER: "${CLUSTER:-mainnet-beta}"
      I_UNDERSTAND_MAINNET: "${I_UNDERSTAND_MAINNET:-1}"
      RPC_URL: "${RPC_URL}"
      KEYPAIR: "/secrets/admin.json"
      CCM_V3_MINT: "${CCM_V3_MINT}"
      HEALTHCHECK_FILE: "/tmp/keeper-heartbeat"
      HEALTHCHECK_MAX_AGE: "7800"
      # DRY_RUN: "1"
      # HARVEST_INTERVAL_MS: "3600000"
    volumes:
      - ${ADMIN_KEYPAIR_PATH:-./.keys/admin.json}:/secrets/admin.json:ro
    healthcheck:
      test: ["CMD", "/usr/local/bin/healthcheck.sh"]
      interval: 120s
      timeout: 5s
      retries: 3
      start_period: 60s
