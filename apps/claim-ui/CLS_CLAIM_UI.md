# CLS Claim UI ‚Äì User Guide

This is the **complete claim interface** for CLS token distribution on Solana mainnet.

## ‚ú® Features

- **Direct Merkle Proof Verification**: No server needed‚Äîproofs are verified entirely on-chain
- **JSON Proof Input**: Upload or paste your proof file (generated by aggregator)
- **Phantom Wallet Integration**: One-click wallet connection
- **Live Balance Tracking**: See your balance before and after claim
- **Manual Instruction Construction**: Uses raw @solana/web3.js (no Anchor IDL)
- **Error Handling**: Clear error messages for double-claims, mismatched wallets, etc.

## üöÄ Quick Start

### For Users

1. **Get Your Proof JSON**
   - Contact the CLS team or visit the distribution portal
   - You'll receive a JSON file like:
     ```json
     {
       "claimer": "YOUR_WALLET_ADDRESS",
       "mint": "TOKEN_MINT_ADDRESS",
       "channel": "stableronaldo",
       "epoch": 1,
       "index": 0,
       "amount": "10000000000",
       "id": "channel:stableronaldo:your-username",
       "root": "0x...",
       "proof": ["0x...", "0x...", "0x..."]
     }
     ```

2. **Open the Claim UI**
   - Visit: `https://claim.twzrd.xyz` (or local dev server)
   - Or run locally: `npm run dev`

3. **Load Your Proof**
   - Upload the JSON file (Step 1)
   - Or paste the JSON directly
   - Click "Parse JSON"

4. **Connect Wallet**
   - Click "Connect Wallet"
   - Sign with Phantom
   - UI will verify the wallet matches your proof

5. **Submit Claim**
   - Review claim details (channel, amount, ID)
   - Click "Submit Claim"
   - Sign the transaction in Phantom
   - Wait for confirmation (~30s)

6. **Verify**
   - See balance before/after
   - Click the Explorer link to view transaction details

### For Developers

#### Running Locally

```bash
cd apps/claim-ui
npm install
npm run dev
```

Open `http://localhost:5173`

#### Environment Variables

Create `.env.local`:

```
VITE_SOLANA_RPC=https://api.mainnet-beta.solana.com
```

#### Building

```bash
npm run build
npm run preview
```

#### Testing with Sample Proof

1. Generate a proof JSON from the CLS aggregator
2. Export it to a file: `proof.json`
3. Paste the contents into the UI's proof input area
4. Follow claim steps above

## üîê Security Notes

- **No Private Keys Stored**: The UI only stores your wallet connection (Phantom handles signing)
- **Proof Verification**: All cryptographic proofs are verified on-chain by the Solana program
- **Double-Claim Guard**: If you try to claim twice, the program rejects it with `AlreadyClaimed` error
- **No Backend**: This is a fully decentralized interface‚Äîno server involvement after proof input

## üèóÔ∏è Architecture

### Component Structure

```
src/
‚îú‚îÄ‚îÄ App.tsx                (Entry point, delegates to ClaimCLS)
‚îú‚îÄ‚îÄ ClaimCLS.tsx          (Main claim component)
‚îú‚îÄ‚îÄ App.css               (Styling)
‚îî‚îÄ‚îÄ main.tsx              (React initialization)
```

### Key Functions in ClaimCLS.tsx

- **`parseProofJSON(json)`**: Validates and parses proof JSON
- **`discriminator(name)`**: Computes SHA256 discriminator for instruction (Web Crypto API)
- **`deriveStreamerKey(channel)`**: Derives PDA seed from channel name (keccak256)
- **`serializeClaimWithRing(args)`**: Borsh-encodes instruction arguments
- **`claim()`**: Main claim submission logic
  - Validates wallet matches
  - Derives PDAs for treasury and claimer accounts
  - Fetches balances before/after
  - Constructs raw instruction (no Anchor IDL)
  - Signs with Phantom and submits to mainnet

### Claim Flow

```
User loads proof JSON
    ‚Üì
Verify wallet is the claimer
    ‚Üì
Fetch current balance
    ‚Üì
Construct claim_with_ring instruction:
  - Discriminator: SHA256("global:claim_with_ring")
  - Args: epoch, index, amount, proof[], id, streamer_key
  - Keys: claimer, protocol PDA, channel PDA, mint, treasury ATA, etc.
    ‚Üì
Sign transaction with Phantom
    ‚Üì
Submit to Solana mainnet
    ‚Üì
Confirm transaction
    ‚Üì
Fetch new balance & display result
```

## üõ†Ô∏è Proof JSON Format

The proof JSON must contain:

```typescript
interface ClaimProof {
  claimer: string;           // Your wallet address (base58)
  mint: string;              // Token mint address
  channel: string;           // Channel name (e.g., "stableronaldo")
  epoch: number;             // Distribution epoch
  index: number;             // Your position in the Merkle tree
  amount: string;            // Amount in token units (e.g., "10000000000" for 10 tokens with 9 decimals)
  id: string;                // Unique claim ID (used in leaf hash)
  root: string;              // Merkle root (hex with or without "0x" prefix)
  proof: string[];           // Merkle proof nodes (hex with or without "0x" prefix)
}
```

### Example

```json
{
  "claimer": "9B5X4b5d6VRvjQvQvQvQvQvQvQvQvQvQvQvQvQvQ1234",
  "mint": "GnGzNdsQMxMpJfMeqnkGPsvHm8kwaDidiKjNU2dCVZop",
  "channel": "stableronaldo",
  "epoch": 1,
  "index": 0,
  "amount": "10000000000",
  "id": "channel:stableronaldo:alice",
  "root": "0x1234abcd...",
  "proof": [
    "0xabcd1234...",
    "0x5678efgh...",
    "0x9012ijkl..."
  ]
}
```

## ‚ùå Common Errors

### "Proof is for X, but you're using Y"
- **Cause**: Your wallet address doesn't match the proof's `claimer` field
- **Fix**: Switch to the correct wallet in Phantom

### "You already claimed this epoch"
- **Cause**: You've already submitted a claim for this epoch
- **Fix**: Wait for the next epoch, or check the Explorer to confirm the first claim succeeded

### "Invalid proof JSON: missing required fields"
- **Cause**: The JSON is missing required fields
- **Fix**: Ensure all fields are present (claimer, mint, channel, epoch, index, amount, id, root, proof)

### "Claim rejected: transaction failed"
- **Cause**: Could be treasury balance too low, proof verification failed, or other on-chain issue
- **Fix**:
  1. Check Explorer for the error details
  2. Verify the proof JSON is correct
  3. Contact CLS team if the issue persists

## üìä What Happens On-Chain

When you submit a claim, the Solana program:

1. **Verifies the Merkle proof** against the stored root
2. **Checks the claim bitmap** to ensure you haven't claimed before
3. **Verifies the leaf hash** matches your wallet + index + amount + ID
4. **Transfers tokens** from treasury to your account (minus 1% transfer fee)
5. **Sets a bit in the bitmap** to prevent double-claiming

## üîó Resources

- **Program ID (Mainnet)**: `GnGzNdsQMxMpJfMeqnkGPsvHm8kwaDidiKjNU2dCVZop`
- **Program Source**: `programs/token-2022/src/instructions/merkle_ring.rs`
- **E2E Test**: `scripts/e2e-direct-manual.ts`
- **RPC Endpoint**: `https://api.mainnet-beta.solana.com`

## üß™ Local Testing

To test the UI locally with a real Solana devnet:

1. Generate a test proof using the aggregator
2. Deploy the program to devnet (or use the mainnet deployment)
3. Run `npm run dev` in `apps/claim-ui`
4. Update `PROGRAM_ID` and `RPC_URL` in `src/ClaimCLS.tsx` if testing on devnet
5. Load your proof and test the claim flow

## üìù License

This UI is part of the Verifiable Distribution Protocol. See repository LICENSE for details.
