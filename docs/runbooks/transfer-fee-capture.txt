# Transfer Fee Capture Runbook (Token-2022 TransferFeeConfig)

This runbook implements the “standard + composable” fee capture path:

- Token-level fee capture via Token-2022 TransferFeeConfig (withheld fees)
- On-chain withdrawal via `harvest_fees` CPI (withdraw authority = `protocol_state` PDA)
- Off-chain only does enumeration + tx composition (no custody keys)
- Claim→swap remains off-chain as a multi-instruction transaction (no on-chain Jupiter CPI)

-------------------------------------------------------------------------------

0) Hard constraints (read first)

1) You cannot add TransferFeeConfig to an already-initialized mint.
   Token-2022’s InitializeTransferFeeConfig is only valid before InitializeMint.
   If your mint already has supply / has been initialized, the practical path is:
   a new mint + migration.

   Practical notes:
   - The transfer-fee “initialize” instruction is intentionally permissionless
     (it has no authority account), so it must be blocked once the mint is live.
   - The stock `spl-token` CLI supports transfer fees at mint creation time
     (`create-token --transfer-fee-basis-points ...`) and updating fees later
     (`set-transfer-fee`), but it does not provide a “retrofit transfer-fee to
     an existing mint” command.

2) Every recipient token account must support fee withholding.
   With transfer fees enabled, destination accounts must include the
   TransferFeeAmount extension. ATAs created for a fee-enabled mint will include
   required extensions; pre-existing accounts for a non-fee mint won’t.

3) Withheld fees accumulate on destination token accounts.
   Fees are not immediately credited to treasury. You must periodically withdraw
   them (batch harvesting).

-------------------------------------------------------------------------------

1) Parameters (initial model)

- FEE_BPS: 300 (3%)
- Policy cap: <= 1000 bps (10%) (enforced by governance/process or program limits;
  Token-2022 itself allows up to 10_000 bps)
- WITHHELD_WITHDRAW_AUTHORITY: protocol_state PDA
  PDA = findProgramAddress(["protocol", <mint>], AO_PROGRAM_ID)
- Destination for withdrawals:
  treasury_ata = ATA(protocol_state, mint, token_program=Token-2022)
- Split: 100% treasury (initial rollout)

Note: Token-2022 also requires an absolute max fee (maximum_fee, token amount).
Pick a value that caps whales without breaking UX. If you want “effectively
uncapped”, set it very high.

-------------------------------------------------------------------------------

2) Mainnet checklist (new mint)

If your current live mint is already initialized (e.g. `ESpcP35W...` on mainnet),
and you require TransferFeeConfig specifically, you must plan for a new mint.
If “new mint” UX is unacceptable, the main alternative is a wrapper approach
(users wrap the old mint into a new Token-2022 mint with the desired extensions),
but that is still a migration surface.

2.1 Create a new Token-2022 mint with transfer fee enabled

Create the mint with TransferFeeConfig enabled at creation time:

  spl-token --program-2022 create-token \
    --decimals 9 \
    --transfer-fee-basis-points 300 \
    --transfer-fee-maximum-fee <MAX_FEE_UI> \
    --transfer-hook <TRANSFER_HOOK_PROGRAM_ID>

Then verify:

  spl-token --program-2022 display <MINT>

You should see both:
- Transfer Fee extension
- Transfer Hook extension (if you enabled it here)

2.2 Initialize protocol PDAs for this mint

Call on-chain:
- initialize_mint(fee_basis_points, max_fee)

This creates:
- protocol_state PDA (authority over treasury ATA; also becomes withdraw authority)
- fee_config PDA

2.3 Set mint authorities

Set withheld withdraw authority to the protocol_state PDA (no hot key):

  spl-token --program-2022 authorize <MINT> withheld-withdraw <PROTOCOL_STATE_PDA>

Optional (recommended): set transfer fee config authority to governance (multisig),
or to the PDA if you want all updates routed through the program:

  spl-token --program-2022 authorize <MINT> transfer-fee-config <GOVERNANCE_AUTHORITY>

2.4 Ensure treasury ATA exists (Token-2022 ATA)

Create / verify the treasury ATA owned by protocol_state:

  spl-token --program-2022 create-account <MINT> --owner <PROTOCOL_STATE_PDA>

2.5 Transfer hook EAML (only if your hook program needs extra accounts)

If your hook program needs extra accounts, initialize the EAML (ccm_hook PDA):

  ts-node scripts/init-eaml.ts <MINT>

If your hook program is ccm_hook and it doesn’t require extra accounts, EAML can
remain empty.

-------------------------------------------------------------------------------

3) On-chain harvesting (AO program)

The AO program’s harvest_fees instruction performs real Token-2022 CPI:

- If you pass token accounts as remaining accounts, it calls
  withdraw_withheld_tokens_from_accounts → treasury_ata.
- If you pass no remaining accounts, it calls
  withdraw_withheld_tokens_from_mint → treasury_ata (requires prior
  harvest_withheld_tokens_to_mint calls).

3.1 Enumerate token accounts off-chain (required)

Programs can’t enumerate all token accounts on-chain. You must fetch them via RPC:

- getProgramAccounts(TokenzQd..., filters: memcmp mint @ offset 0)
- Batch to <= 255 accounts per harvest_fees call.

This repo includes a helper:

  ts-node scripts/harvest-fees.ts <MINT>

-------------------------------------------------------------------------------

4) Claim → Jupiter swap (off-chain composer)

Keep the AO program lean:

1) Build a single transaction with:
   - claim_channel_open (or your claim instruction)
   - Jupiter swap instruction(s) to swap CCM → SOL/USDC
2) Use user-provided min_out from a Jupiter quote to enforce slippage.
3) Use Versioned TX + ALTs if needed for account limits.

No on-chain Jupiter CPI required.

-------------------------------------------------------------------------------

5) Testnet first (recommended)

1) Repeat mint creation on devnet/testnet
2) Deploy a new AO program ID (or use separate config)
3) End-to-end test:
   - transfers accumulate withheld fees
   - harvest_fees increases treasury balance
   - claim → swap works in a single tx

-------------------------------------------------------------------------------

6) Block conditions

- Mint already initialized without TransferFeeConfig → cannot retrofit (new mint required).
- Mint authority / fee authorities not controlled → you may be unable to set:
  - withheld-withdraw
  - transfer-fee-config
- Withdraw authority not equal to protocol_state PDA → harvest_fees rejects.
