## 1. Repository Scope

  This repo is **open-core**:

  - `programs/token_2022/`
    - Mainnet program `GnGzNdsQMxMpJfMeqnkGPsvHm8kwaDidiKjNU2dCVZop`
    - Anchor 0.32.1 + Solana SDK 2.3.x
    - Production settlement + transfer-hook logic (ring buffer,
  passports, governance)

  - `oracles/x402-switchboard/`
    - Minimal x402 + Switchboard demo
    - Off-chain only; reference implementation

  - `programs/attention_oracle_program/`
    - Lite Merkle verifier + payout bitmap (experimental / auxiliary)
    - Must stay **byte-for-byte compatible** with off-chain hashing
  and PDA seeds

  **Do not introduce** new public apps, dashboards, or internal
  strategy docs. This repo is on-chain programs + minimal oracle
  demo only.

  ---

  ## 2. Toolchain & Lints (Do Not Break)

  Tooling is carefully pinned:

  - Workspace Rust: **1.91.1**
  - SBF toolchain (Agave platform tools): **rustc 1.84.1-sbpf**
  - Anchor: **0.32.1**
  - Solana CLI / SDK: **2.3.x** (Solana/Agave series)
  - Agave validator: **3.0.x** (runtime only; deploys still use
  upgradeable loader)

  Key constraints:

  - `programs/token_2022/Cargo.toml`:
    - `rust-version = "1.84"` (must not bump until Agave SBF moves
  up)
  - Root `Cargo.toml`:
    - `[profile.release]` is defined **only at workspace root**.
      Do not reintroduce `[profile.*]` inside member packages.
  - `programs/token_2022/src/lib.rs`:
    - Crate-level lints:
      `#![warn(clippy::all, clippy::pedantic, clippy::nursery)]`
      plus a curated `#![allow(...)]` list for Anchor/SBF-specific
  patterns

  **Copilot must:**

  - Keep all code compiling with this pinned stack.
  - Preserve Clippy “zero warnings” under the existing allowlist.
  - Avoid changing `rust-version` or `solana-program` versions unless
  the PR explicitly says we’re upgrading the toolchain.

  ---

  ## 3. CI & Verification Rules

  Core workflows:

  - `.github/workflows/verify.yml`
    - Runs:
      - `cargo clippy --all-targets --all-features -- -D warnings`
      - `anchor build` (from **repo root** or with the correct
  `working-directory`)
      - `ls` on compiled artifacts and IDLs
      - `anchor verify token_2022` on `main`
  - `.github/workflows/guard.yml`
    - Enforces:
      - No forbidden paths (`apps/*` except the allowed oracle)
      - No `node_modules`, `dist`, `logs`, `.env`, or `keys/
  ` anywhere
  - `.github/workflows/canary-upgrade.yml`
    - Canary deploy + summary (heredocs rely on unquoted `EOF` for
  expression expansion)

  **Copilot must:**

  - Never change CI paths blindly.
    Respect `defaults.run.working-directory`. E.g., if `working-
  directory: programs/token_2022` is set, then:
    - Artifacts are at `target/deploy/token_2022.so` and `target/idl/
  token_2022.json` (no extra `programs/token_2022/` prefix).
  - Keep `Verify Program` able to:
    - Build `token_2022`
    - Confirm `.so` and IDL exist
    - Run `anchor verify token_2022` (requires `DEVNET_DEPLOY_KEY`
  secret on main)
  - Preserve guard behavior; do not loosen forbidden path checks.

  ---

  ## 4. Naming, Secrets, and Public Surface

  **Strict rules:**

  - No references to **MILO** or internal project names in code,
  comments, or docs.
  - Token name references should use neutral language (e.g. “CCM”,
  “XYZ”) or generic “token”/“points” semantics.
  - Do not add or log private keys, secrets, or internal URLs.
    - Secrets belong only in GitHub Actions secrets and are accessed
  via `${{ secrets.NAME }}`.
  - No internal strategy docs, pitch decks, or investor material in
  this repo.

  **Copilot must:**

  - Avoid generating variable/module names that leak internal
  projects.
  - When editing README/ARCHITECTURE, keep language “builder-neutral”
  and focused on protocol behavior.

  ---

  ## 5. Program-Level Rules

  ### 5.1 `token_2022` (main program)

  - `declare_id!` must remain:
    `GnGzNdsQMxMpJfMeqnkGPsvHm8kwaDidiKjNU2dCVZop`
  - Entry points must keep the existing names and signatures (IDL
  stability).
  - Ring buffer / passport / hooks / governance logic is
  **canonical**. Only change behavior if the PR explicitly asks for
  it and tests are updated.

  ### 5.2 `attention_oracle_program` (Lite verifier)

  - This crate implements:
    - `update_root` (channel + epoch + Merkle root + total_amount)
    - `claim` (Merkle proof verification + claimed bitmap + token
  payout via CPI)
  - Security rules:
    - `update_root` must be **access-controlled** (oracle/admin key
  or config PDA).
      Never accept arbitrary signers without checking against a
  trusted key.
    - `claim` must:
      - Bind the leaf to `claimer` pubkey.
      - Enforce bitmap double-claim protection.
  - PDA seeds and Keccak hashing must stay **byte-for-byte**
  compatible with the off-chain implementation.

  **Copilot must:**

  - Preserve PDA seeds and hashing order (no refactors that change
  layout).
  - Call out any missing access control or double-claim protections
  in reviews.

  ---

  ## 6. PR Review Checklist (for Copilot)

  When reviewing a PR, Copilot should check and comment on:

  1. **Does it build?**
     - `anchor build` from repo root succeeds.
     - No new Clippy warnings under the current allowlist.

  2. **Does it respect the toolchain?**
     - No changes to `rust-version` or Solana/Anchor versions unless
  requested.
     - No new `[profile.*]` sections in member crates.

  3. **Are CI paths correct?**
     - Workflows use the right artifact paths given their `working-
  directory`.
     - No secrets added in plaintext.

  4. **Does it change public interfaces or program IDs?**
     - If yes, highlight that this breaks IDL / client compatibility
  and must be carefully reviewed.

  5. **Does it leak internal names or strategy?**
     - No mentions of MILO or internal project names.
     - Docs stay builder-neutral.

  ---

  ## 7. When in Doubt

  If a change:

  - Touches program IDs,
  - Adjusts toolchain versions,
  - Modifies PDA seeds or hashing logic,

  **Copilot should flag it as high-risk and recommend explicit human
  review**, rather than “auto-approve” or silently updating code.

  This project is built and verified in public; correctness and
  reproducibility matter more than clever shortcuts.
