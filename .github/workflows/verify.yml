name: verified-build

on:
  push:
    tags:
      - 'v*'

jobs:
  verify:
    runs-on: ubuntu-latest
    env:
      PROGRAM_ID: GnGzNdsQMxMpJfMeqnkGPsvHm8kwaDidiKjNU2dCVZop
      RPC_URL: https://api.mainnet-beta.solana.com
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Anchor verifiable build (container)
        run: |
          docker run --rm -v "$PWD":/work -w /work solanafoundation/anchor:v0.32.1 anchor --version
          docker run --rm -v "$PWD":/work -w /work solanafoundation/anchor:v0.32.1 anchor build --verifiable

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install solana-verify
        run: cargo install solana-verify --version 0.4.11

      - name: Canonical hash compare
        run: |
          LOCAL=$(solana-verify get-executable-hash target/verifiable/token_2022.so)
          REMOTE=$(solana-verify get-program-hash -u "$RPC_URL" "$PROGRAM_ID")
          echo "Local:  $LOCAL"
          echo "Remote: $REMOTE"
          if [ "$LOCAL" != "$REMOTE" ]; then
            echo "Mismatch: canonical hash differs" >&2
            exit 1
          fi
          echo "Match: canonical hash verified"
