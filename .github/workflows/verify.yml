name: Verify Program

on:
  push:
    branches: [main]
  pull_request:

jobs:
  verify:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: programs/token_2022
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: clippy
      - name: Add cargo to PATH
        run: echo "$HOME/.cargo/bin" >> $GITHUB_PATH
      - name: Install Agave 3.0.10
        run: sh -c "$(curl -sSfL https://release.anza.xyz/v3.0.10/install)"
      - name: Add Agave to PATH
        run: echo "$HOME/.local/share/agave/install/active_release/bin" >> $GITHUB_PATH
      - name: Verify build + IDL
        run: |
          anchor build
          ls -l target/deploy/token_2022.so target/idl/token_2022.json
      - name: Verify on-chain matches source (main only)
        if: github.ref == 'refs/heads/main'
        env:
          ANCHOR_WALLET: ${{ secrets.DEVNET_DEPLOY_KEY }}
        run: anchor verify token_2022
