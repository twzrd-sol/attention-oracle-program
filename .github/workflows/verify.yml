name: verified-build

on:
  push:
    tags:
      - 'v*'

jobs:
  verify:
    runs-on: ubuntu-latest
    env:
      PROGRAM_ID: GnGzNdsQMxMpJfMeqnkGPsvHm8kwaDidiKjNU2dCVZop
      RPC_URL: https://api.mainnet-beta.solana.com
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Solana (3.0.10)
        shell: bash
        run: |
          set -euo pipefail
          sh -c "$(curl -sSfL https://release.anza.xyz/v3.0.10/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Install Rust toolchain (1.91.1)
        uses: dtolnay/rust-toolchain@1.91.1

      - name: Cache Cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-verify-${{ hashFiles('**/Cargo.lock') }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libudev-dev pkg-config libssl-dev

      - name: Install Anchor CLI 0.32.1
        run: cargo install --locked anchor-cli --version 0.32.1

      - name: Build verifiable (Docker)
        run: |
          anchor build --verifiable -p token_2022
          find . -name "token_2022.so" -type f | head -5

      - name: Install solana-verify
        run: cargo install solana-verify --version 0.4.11

      - name: Canonical hash compare
        run: |
          SO=$(find target -name "token_2022.so" -type f | head -n 1)
          if [ -z "$SO" ]; then
            echo "No token_2022.so found" >&2
            exit 1
          fi
          LOCAL=$(solana-verify get-executable-hash "$SO")
          REMOTE=$(solana-verify get-program-hash -u "$RPC_URL" "$PROGRAM_ID")
          echo "Local:  $LOCAL"
          echo "Remote: $REMOTE"
          echo "local=$LOCAL" >> $GITHUB_OUTPUT
          echo "remote=$REMOTE" >> $GITHUB_OUTPUT
          if [ "$LOCAL" != "$REMOTE" ]; then
            echo "::warning::Hash mismatch - local build differs from on-chain"
            echo "This may be expected if on-chain was upgraded with different features"
          else
            echo "::notice::Verified - local build matches on-chain program"
          fi

      - name: Summary
        run: |
          echo "## Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Program ID | \`$PROGRAM_ID\` |" >> $GITHUB_STEP_SUMMARY
          echo "| On-chain Hash | \`$(solana-verify get-program-hash -u "$RPC_URL" "$PROGRAM_ID")\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Local Hash | \`$(solana-verify get-executable-hash $(find target -name 'token_2022.so' -type f | head -n 1))\` |" >> $GITHUB_STEP_SUMMARY
