name: Verify Program

on:
  push:
    branches: [main]
  pull_request:

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: clippy
      - name: Install native dependencies (fixes hidapi + protobuf + ssl)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libssl-dev \
            libudev-dev \
            libclang-dev \
            protobuf-compiler
      - name: Install Anchor CLI v0.32.1 direct (no avm, zero flakes)
        run: |
          cargo install anchor-cli \
            --git https://github.com/coral-xyz/anchor \
            --tag v0.32.1 \
            --locked \
            --force \
            --root $HOME/.local

          echo "$HOME/.local/bin" >> $GITHUB_PATH
          anchor --version
      - name: Install Agave 3.0.10
        run: sh -c "$(curl -sSfL https://release.anza.xyz/v3.0.10/install)"
      - name: Add Agave to PATH
        run: echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
      - name: Versions
        run: |
          anchor --version
          solana --version
          rustc --version
      - name: Clippy zero
        working-directory: programs/token_2022
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Verifiable build (Anchor Docker - deterministic)
        run: anchor build --verifiable
        env:
          ANCHOR_VERSION: 0.32.1

      - name: Verify on-chain hash (PERMANENT CRYPTOGRAPHIC LOCK)
        run: |
          echo "=== Downloading on-chain program ==="
          solana program dump GnGzNdsQMxMpJfMeqnkGPsvHm8kwaDidiKjNU2dCVZop on-chain.so --url mainnet-beta

          echo "=== Computing hashes (trimming on-chain padding) ==="
          LOCAL_SIZE=$(stat -c%s target/verifiable/token_2022.so)
          VERIFIABLE_HASH=$(sha256sum target/verifiable/token_2022.so | cut -d' ' -f1)
          ON_CHAIN_HASH=$(head -c "$LOCAL_SIZE" on-chain.so | sha256sum | cut -d' ' -f1)

          echo "Verifiable build: $VERIFIABLE_HASH ($LOCAL_SIZE bytes)"
          echo "On-chain (trimmed): $ON_CHAIN_HASH (trimmed to $LOCAL_SIZE bytes)"

          if [ "$VERIFIABLE_HASH" = "$ON_CHAIN_HASH" ]; then
            echo "✅ VERIFIED: On-chain program cryptographically matches repository"
            echo "   Anchor 0.32.1 deterministic Docker build = immutable proof"
            echo "   No hash drift possible. Machine sovereign."
          else
            echo "❌ VERIFICATION FAILED: Hash mismatch"
            echo "   This means deployed binary ≠ source code"
            exit 1
          fi
