name: Verify Program

on:
  push:
    branches: [main]
  pull_request:

jobs:
  verify:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: clippy
      - name: Install native dependencies (fixes hidapi + protobuf + ssl)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libssl-dev \
            libudev-dev \
            libclang-dev \
            protobuf-compiler
      - name: Install Anchor CLI v0.32.1 direct (no avm, zero flakes)
        run: |
          cargo install anchor-cli \
            --git https://github.com/coral-xyz/anchor \
            --tag v0.32.1 \
            --locked \
            --force \
            --root $HOME/.local

          echo "$HOME/.local/bin" >> $GITHUB_PATH
          anchor --version
      - name: Install Agave 3.0.10
        run: sh -c "$(curl -sSfL https://release.anza.xyz/v3.0.10/install)"
      - name: Add Agave to PATH
        run: echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
      - name: Versions
        run: |
          anchor --version
          solana --version
          rustc --version
      - name: Clippy zero
        working-directory: programs/token_2022
        run: cargo clippy --all-targets --all-features -- -D warnings
      - name: Build program + IDL
        run: anchor build
        env:
          SOLANA_VERSION: 2.0.3
          ANCHOR_VERSION: 0.32.1
          RUST_TOOLCHAIN: 1.91.0
      - name: Verify build + IDL
        run: ls -l target/deploy/token_2022.so target/idl/token_2022.json
      - name: Verify on-chain (main only)
        if: github.ref == 'refs/heads/main'
        env:
          ANCHOR_WALLET: ${{ secrets.MAINNET_UPGRADE_KEY }}
        run: |
          anchor verify GnGzNdsQMxMpJfMeqnkGPsvHm8kwaDidiKjNU2dCVZop \
            --provider.cluster mainnet \
            --repo-url https://github.com/twzrd-sol/attention-oracle-program \
            --program-name token_2022 \
            --commit-hash ${{ github.sha }}
