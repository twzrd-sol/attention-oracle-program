name: Verify Program

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      ref:
        description: "Git ref (tag) to verify, e.g. refs/tags/v1.2.1"
        required: true
        default: "refs/tags/v1.2.1"

jobs:
  verify:
    # Only verify immutable refs (release tags) or explicit manual input
    if: github.event_name == 'release' || github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.ref || github.ref }}
      - name: Print ref
        run: |
          echo "event=${{ github.event_name }}"
          echo "github.ref=${{ github.ref }}"
          echo "inputs.ref=${{ github.event.inputs.ref }}"
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          components: clippy
      - name: Install native dependencies (fixes hidapi + protobuf + ssl)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            pkg-config \
            libssl-dev \
            libudev-dev \
            libclang-dev \
            protobuf-compiler
      - name: Install Anchor CLI v0.32.1 direct (no avm, zero flakes)
        run: |
          cargo install anchor-cli \
            --git https://github.com/coral-xyz/anchor \
            --tag v0.32.1 \
            --locked \
            --force \
            --root $HOME/.local

          echo "$HOME/.local/bin" >> $GITHUB_PATH
          anchor --version
      - name: Install Agave 3.0.10
        run: sh -c "$(curl -sSfL https://release.anza.xyz/v3.0.10/install)"
      - name: Add Agave to PATH
        run: echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
      - name: Versions
        run: |
          anchor --version
          solana --version
          rustc --version
      - name: Clippy zero
        working-directory: programs/token_2022
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Nuclear clean (destroy ALL cache)
        run: |
          rm -rf programs/token_2022/target
          rm -rf target
          cargo clean --manifest-path programs/token_2022/Cargo.toml

      - name: Build program (deterministic cargo build-sbf)
        working-directory: programs/token_2022
        run: cargo build-sbf --sbf-out-dir target/deploy

      - name: Verify on-chain hash (PERMANENT LOCK)
        run: |
          echo "=== Downloading on-chain program ==="
          solana program dump GnGzNdsQMxMpJfMeqnkGPsvHm8kwaDidiKjNU2dCVZop on-chain.so --url mainnet-beta

          echo "=== Computing hashes (trimming on-chain account padding) ==="
          LOCAL_HASH=$(sha256sum programs/token_2022/target/deploy/token_2022.so | cut -d' ' -f1)
          LOCAL_SIZE=$(stat -c%s programs/token_2022/target/deploy/token_2022.so)
          ON_CHAIN_HASH=$(head -c "$LOCAL_SIZE" on-chain.so | sha256sum | cut -d' ' -f1)

          echo "Local build (cargo build-sbf): $LOCAL_HASH ($LOCAL_SIZE bytes)"
          echo "On-chain (trimmed):             $ON_CHAIN_HASH"

          if [ "$LOCAL_HASH" = "$ON_CHAIN_HASH" ]; then
            echo "✅ VERIFIED: On-chain matches repository (Solana 3.0.10 + Rust 1.91.1)"
            echo "   Build command: cargo build-sbf"
            echo "   Toolchain locked. No hash drift possible."
          else
            echo "❌ VERIFICATION FAILED: On-chain ≠ repository"
            exit 1
          fi
