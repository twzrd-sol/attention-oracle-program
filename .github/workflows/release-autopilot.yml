name: Release Autopilot (Verify â†’ OtterSec)

on:
  push:
    tags: [ 'v*' ]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.2.1)'
        required: true
        type: string

env:
  PROGRAM_ID: GnGzNdsQMxMpJfMeqnkGPsvHm8kwaDidiKjNU2dCVZop
  SOLANA_VERSION: '3.0.10'
  ANCHOR_VERSION: '0.32.1'

jobs:
  build-and-verify:
    name: Build & Verify Reproducibility
    runs-on: ubuntu-latest
    outputs:
      binary_hash: ${{ steps.hash.outputs.sha256 }}
      binary_size: ${{ steps.size.outputs.bytes }}
      on_chain_match: ${{ steps.verify.outputs.match }}
      tag_name: ${{ steps.tag.outputs.name }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ inputs.tag }}"
          else
            TAG=${GITHUB_REF#refs/tags/}
          fi
          echo "name=$TAG" >> $GITHUB_OUTPUT
          echo "Release tag: $TAG"

      - name: Setup Solana CLI
        shell: bash
        run: |
          set -euo pipefail
          echo "Installing Solana CLI v${{ env.SOLANA_VERSION }}"
          for attempt in 1 2 3; do
            if curl -fsSL "https://release.anza.xyz/v${{ env.SOLANA_VERSION }}/install" | sh; then
              break
            fi
            sleep 3
          done
          echo "$HOME/.local/share/solana/install/active_release/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana --version

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@1.91.1

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            programs/target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Build SBF (Reproducible)
        working-directory: programs
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          cargo build-sbf --sbf-out-dir target/deploy
          ls -lh target/deploy/token_2022.so

      - name: Compute binary hash
        id: hash
        run: |
          SHA=$(sha256sum programs/target/deploy/token_2022.so | cut -d' ' -f1)
          echo "sha256=$SHA" >> $GITHUB_OUTPUT
          echo "âœ… Binary SHA256: $SHA"

      - name: Get binary size
        id: size
        run: |
          SIZE=$(stat -c%s programs/target/deploy/token_2022.so)
          echo "bytes=$SIZE" >> $GITHUB_OUTPUT
          echo "âœ… Binary size: $SIZE bytes"

      - name: Download on-chain program
        run: |
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana program dump ${{ env.PROGRAM_ID }} on-chain.so --url mainnet-beta
          ls -lh on-chain.so

      - name: Trim and verify on-chain binary
        id: verify
        run: |
          LOCAL_SIZE=${{ steps.size.outputs.bytes }}
          head -c "$LOCAL_SIZE" on-chain.so > on-chain-trimmed.so
          ON_CHAIN_HASH=$(sha256sum on-chain-trimmed.so | cut -d' ' -f1)
          LOCAL_HASH=${{ steps.hash.outputs.sha256 }}

          echo "Local:    $LOCAL_HASH"
          echo "On-chain: $ON_CHAIN_HASH"

          if [ "$LOCAL_HASH" = "$ON_CHAIN_HASH" ]; then
            echo "match=true" >> $GITHUB_OUTPUT
            echo "âœ… VERIFICATION PASSED: Hashes match!"
          else
            echo "match=false" >> $GITHUB_OUTPUT
            echo "âŒ VERIFICATION FAILED: Hash mismatch!"
            exit 1
          fi

      - name: Extract IDL
        continue-on-error: true
        run: |
          cargo install --locked anchor-cli --version ${{ env.ANCHOR_VERSION }} || true
          mkdir -p target/idl
          anchor idl parse -f programs/token_2022/src/lib.rs -o target/idl/token_2022.json || true
          if [ -f target/idl/token_2022.json ]; then
            jq -r '.version' target/idl/token_2022.json || true
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: verified-release-${{ steps.tag.outputs.name }}
          path: |
            programs/target/deploy/token_2022.so
            target/idl/token_2022.json
            on-chain-trimmed.so
          retention-days: 90

  create-release:
    name: Create GitHub Release
    needs: build-and-verify
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      release_url: ${{ steps.release.outputs.url }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: verified-release-${{ needs.build-and-verify.outputs.tag_name }}
          path: dist

      - name: Generate release notes
        id: notes
        run: |
          cat > RELEASE_NOTES.md << 'EOF'
          # Attention Oracle Release ${{ needs.build-and-verify.outputs.tag_name }}

          ## âœ… Verified Reproducible Build

          **Program ID**: `${{ env.PROGRAM_ID }}`
          **Binary SHA256**: `${{ needs.build-and-verify.outputs.binary_hash }}`
          **Binary Size**: ${{ needs.build-and-verify.outputs.binary_size }} bytes
          **On-Chain Match**: ${{ needs.build-and-verify.outputs.on_chain_match }}

          ## Build Environment

          - Solana CLI: ${{ env.SOLANA_VERSION }}
          - Anchor: ${{ env.ANCHOR_VERSION }}
          - Rust: 1.91.1

          ## Verification

          To reproduce this build:

          ```bash
          git clone https://github.com/twzrd-sol/attention-oracle-program.git
          cd attention-oracle-program
          git checkout ${{ needs.build-and-verify.outputs.tag_name }}
          cd programs
          cargo build-sbf
          sha256sum target/deploy/token_2022.so
          # Expected: ${{ needs.build-and-verify.outputs.binary_hash }}
          ```

          ## OtterSec Verify

          This release has been automatically submitted to [OtterSec Verify](https://verify.osec.io).

          ## Artifacts

          - `token_2022.so` - Verified program binary
          - `token_2022.json` - Anchor IDL (if available)
          - `on-chain-trimmed.so` - On-chain program dump (trimmed to match local size)

          ---

          ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          EOF
          echo "Generated release notes"

      - name: Create GitHub Release
        id: release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=${{ needs.build-and-verify.outputs.tag_name }}

          # Create or update release
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG exists, updating..."
            gh release edit "$TAG" -F RELEASE_NOTES.md
          else
            echo "Creating new release $TAG..."
            gh release create "$TAG" -F RELEASE_NOTES.md -t "$TAG"
          fi

          # Upload artifacts
          gh release upload "$TAG" dist/token_2022.so --clobber
          [ -f dist/token_2022.json ] && gh release upload "$TAG" dist/token_2022.json --clobber || true

          # Get release URL
          RELEASE_URL=$(gh release view "$TAG" --json url -q .url)
          echo "url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "âœ… Release published: $RELEASE_URL"

  ottersec-submit:
    name: Submit to OtterSec Verify
    needs: [build-and-verify, create-release]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare OtterSec submission
        run: |
          cat > ottersec-submission.json << EOF
          {
            "program_id": "${{ env.PROGRAM_ID }}",
            "network": "mainnet-beta",
            "repository": "https://github.com/twzrd-sol/attention-oracle-program",
            "commit": "${{ github.sha }}",
            "tag": "${{ needs.build-and-verify.outputs.tag_name }}",
            "binary_hash": "${{ needs.build-and-verify.outputs.binary_hash }}",
            "binary_size": ${{ needs.build-and-verify.outputs.binary_size }},
            "build_command": "cd programs && cargo build-sbf",
            "solana_version": "${{ env.SOLANA_VERSION }}",
            "verified_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "github_release": "${{ needs.create-release.outputs.release_url }}"
          }
          EOF
          cat ottersec-submission.json

      - name: Submit to OtterSec (placeholder)
        run: |
          echo "ðŸ“‹ OtterSec submission prepared:"
          cat ottersec-submission.json
          echo ""
          echo "ðŸ”— Manual submission required at: https://verify.osec.io"
          echo "   Program ID: ${{ env.PROGRAM_ID }}"
          echo "   Repository: https://github.com/twzrd-sol/attention-oracle-program"
          echo "   Tag: ${{ needs.build-and-verify.outputs.tag_name }}"
          echo ""
          echo "â„¹ï¸  OtterSec Verify API integration coming soon"

      - name: Upload submission data
        uses: actions/upload-artifact@v4
        with:
          name: ottersec-submission-${{ needs.build-and-verify.outputs.tag_name }}
          path: ottersec-submission.json
          retention-days: 365

  summary:
    name: Release Summary
    needs: [build-and-verify, create-release, ottersec-submit]
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸš€ Release Autopilot Complete

          ## Release: ${{ needs.build-and-verify.outputs.tag_name }}

          ### âœ… Verification Status

          | Check | Status |
          |-------|--------|
          | Reproducible Build | âœ… Passed |
          | On-Chain Match | ${{ needs.build-and-verify.outputs.on_chain_match == 'true' && 'âœ… Verified' || 'âŒ Failed' }} |
          | Binary Hash | `${{ needs.build-and-verify.outputs.binary_hash }}` |
          | Binary Size | ${{ needs.build-and-verify.outputs.binary_size }} bytes |

          ### ðŸ“¦ Artifacts

          - [GitHub Release](${{ needs.create-release.outputs.release_url }})
          - Program Binary: `token_2022.so`
          - Anchor IDL: `token_2022.json`

          ### ðŸ” Next Steps

          1. **OtterSec Verify**: Check artifacts for submission data
          2. **Announce**: Update community on release
          3. **Monitor**: Watch for any upgrade issues

          ---

          ðŸ¤– Automated by Release Autopilot
          EOF
