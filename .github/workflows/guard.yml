name: Repo Scope Guard

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Fail on forbidden paths
        shell: bash
        run: |
          set -euo pipefail
          FILES="$(git ls-files)"
          # 1) Allow only: programs/token_2022, programs/attention_oracle_program, oracles/x402-switchboard
          ALLOWED="^(programs/(token_2022|attention_oracle_program)|oracles/x402-switchboard)(/|$)"
          FORBIDDEN_DIRS=$(echo "$FILES" | grep -E '^(programs|oracles)/' | grep -Ev "$ALLOWED" || true)
          if [ -n "$FORBIDDEN_DIRS" ]; then
            echo "❌ Forbidden paths detected (only token_2022, attention_oracle_program, x402-switchboard allowed):"
            echo "$FORBIDDEN_DIRS"
            exit 1
          fi
          # 2) Forbid vendored/build/keys directories anywhere in tree
          if echo "$FILES" | grep -E '(^|/)(node_modules|dist|logs|keys)(/|$)' | grep -q .; then
            echo "❌ Forbidden vendored/build/keys paths detected"
            exit 1
          fi
          # 3) Forbid .env files (but allow .env.example)
          if echo "$FILES" | grep -E '(^|/)\.env($|/)' | grep -q .; then
            echo "❌ Forbidden .env path detected"
            exit 1
          fi
          # 4) Forbid database artifacts (*.db)
          if echo "$FILES" | grep -E '\.db($|/|\.)' | grep -q .; then
            echo "❌ Forbidden database artifact detected"
            exit 1
          fi
          echo "✅ Guard passed: scope is clean"
